<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Medicine Schedule</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="medicine-schedule-overall-body">
    <div class="medschedule-overall-container">
        <header class="medschedule-overall-header">
            <h1 class="medschedule-overall-title">Monthly Medicine Schedule</h1>
            <p class="medschedule-overall-subtitle">Track your medications with our pastel-colored monthly calendar</p>
            <div class="medschedule-overall-user-info">
                <div class="medschedule-overall-user-avatar">ES</div>
                <div>
                    <h3>Emma Smith</h3>
                    <p>Medication schedule for October 2023</p>
                </div>
            </div>
        </header>

        <div class="medschedule-overall-controls">
            <div class="medschedule-overall-month-selector">
                <button class="medschedule-overall-btn" id="prevMonth">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <div class="medschedule-overall-month-display" id="currentMonth">October 2023</div>
                <button class="medschedule-overall-btn" id="nextMonth">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <button class="medschedule-overall-btn" id="printSchedule">
                <i class="fas fa-print"></i> Print Schedule
            </button>
        </div>

        <div class="medschedule-overall-calendar" id="calendar">
            <!-- Calendar headers -->
            <div class="medschedule-overall-day-header">Sunday</div>
            <div class="medschedule-overall-day-header">Monday</div>
            <div class="medschedule-overall-day-header">Tuesday</div>
            <div class="medschedule-overall-day-header">Wednesday</div>
            <div class="medschedule-overall-day-header">Thursday</div>
            <div class="medschedule-overall-day-header">Friday</div>
            <div class="medschedule-overall-day-header">Saturday</div>
            
            <!-- Calendar days will be generated by JavaScript -->
        </div>

        <div class="medschedule-overall-legend">
            <div class="medschedule-overall-legend-item">
                <div class="medschedule-overall-legend-color medschedule-overall-morning"></div>
                <span>Morning (6AM-12PM)</span>
            </div>
            <div class="medschedule-overall-legend-item">
                <div class="medschedule-overall-legend-color medschedule-overall-afternoon"></div>
                <span>Afternoon (12PM-6PM)</span>
            </div>
            <div class="medschedule-overall-legend-item">
                <div class="medschedule-overall-legend-color medschedule-overall-evening"></div>
                <span>Evening (6PM-10PM)</span>
            </div>
            <div class="medschedule-overall-legend-item">
                <div class="medschedule-overall-legend-color medschedule-overall-night"></div>
                <span>Night (10PM-6AM)</span>
            </div>
        </div>

        <footer class="medschedule-overall-footer">
            <p><i class="fas fa-heart"></i> Always consult your doctor before making changes to your medication schedule</p>
        </footer>
    </div>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDate = new Date();
    const calendarElement = document.getElementById('calendar');
    const currentMonthElement = document.getElementById('currentMonth');
    const prevMonthButton = document.getElementById('prevMonth');
    const nextMonthButton = document.getElementById('nextMonth');
    const printButton = document.getElementById('printSchedule');
    
    // Get user data from localStorage
    const userData = JSON.parse(localStorage.getItem('user') || '{}');
    const userName = userData.name || 'User';
    const userAvatar = document.querySelector('.medschedule-overall-user-avatar');
    
    // Update user info in header
    if (userAvatar) {
        const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
        userAvatar.textContent = initials;
    }
    
    document.querySelector('.medschedule-overall-user-info h3').textContent = userName;
    
    async function loadMonthlyReminders() {
        try {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const response = await fetch(`http://localhost:5000/api/medications/reminders`, {
                method: 'GET',
                headers: { 
                    'Authorization': `Bearer ${user.user_id}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch reminders');
            }
            
            const data = await response.json();
            return data.reminders || [];
        } catch (error) {
            console.error('Error loading monthly reminders:', error);
            return [];
        }
    }

    async function renderCalendar(date) {
        // Clear existing calendar days
        const existingDays = document.querySelectorAll('.medschedule-overall-day');
        existingDays.forEach(day => day.remove());
        
        // Update month display
        currentMonthElement.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });
        
        // Update user info
        document.querySelector('.medschedule-overall-user-info p').textContent = 
            `Medication schedule for ${date.toLocaleString('default', { month: 'long', year: 'numeric' })}`;
        
        // Get calendar dates
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay();
        
        // Load ALL reminders
        const allReminders = await loadMonthlyReminders();
        
        // Group reminders by day for the current month
        const remindersByDay = {};
        
        allReminders.forEach(reminder => {
            const reminderDate = new Date(reminder.reminder_time);
            const reminderDay = reminderDate.getDate();
            const reminderMonth = reminderDate.getMonth();
            const reminderYear = reminderDate.getFullYear();
            
            // Only include reminders for the current calendar month
            if (reminderMonth === date.getMonth() && reminderYear === date.getFullYear()) {
                if (!remindersByDay[reminderDay]) {
                    remindersByDay[reminderDay] = [];
                }
                
                // Determine time of day for color coding
                const hour = reminderDate.getHours();
                let timeOfDay = 'morning';
                if (hour >= 12 && hour < 18) timeOfDay = 'afternoon';
                else if (hour >= 18 && hour < 22) timeOfDay = 'evening';
                else if (hour >= 22 || hour < 6) timeOfDay = 'night';
                
                // Determine icon
                let icon = 'fa-capsules';
                const nameLower = reminder.name.toLowerCase();
                if (nameLower.includes('vitamin')) icon = 'fa-apple-alt';
                else if (nameLower.includes('aspirin') || nameLower.includes('pain')) icon = 'fa-pills';
                else if (nameLower.includes('blood') || nameLower.includes('pressure')) icon = 'fa-heartbeat';
                else if (nameLower.includes('allergy')) icon = 'fa-wind';
                
                remindersByDay[reminderDay].push({
                    name: reminder.name,
                    dosage: reminder.dosage,
                    time: timeOfDay,
                    icon: icon,
                    reminder_time: reminder.reminder_time,
                    status: reminder.status
                });
            }
        });
        
        // Add empty cells for days before the first day of the month
        for (let i = 0; i < startingDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'medschedule-overall-day';
            emptyDay.innerHTML = '<div class="medschedule-overall-empty"></div>';
            calendarElement.appendChild(emptyDay);
        }
        
        // Add days of the month with reminders
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'medschedule-overall-day';
            
            // Check if this is today
            if (date.getMonth() === today.getMonth() && 
                date.getFullYear() === today.getFullYear() && 
                day === today.getDate()) {
                dayElement.classList.add('medschedule-overall-today');
            }
            
            // Add date
            const dateElement = document.createElement('div');
            dateElement.className = 'medschedule-overall-date';
            dateElement.textContent = day;
            dayElement.appendChild(dateElement);
            
            // Add reminders for this day if any
            if (remindersByDay[day] && remindersByDay[day].length > 0) {
                remindersByDay[day].forEach(reminder => {
                    const medElement = document.createElement('div');
                    medElement.className = `medschedule-overall-medication medschedule-overall-${reminder.time}`;
                    medElement.innerHTML = `<i class="fas ${reminder.icon}"></i> ${reminder.name}`;
                    dayElement.appendChild(medElement);
                });
            } else {
                const emptyElement = document.createElement('div');
                emptyElement.className = 'medschedule-overall-empty';
                emptyElement.textContent = '';
                dayElement.appendChild(emptyElement);
            }
            
            calendarElement.appendChild(dayElement);
        }
    }
    
    // Event listeners for month navigation
    prevMonthButton.addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar(currentDate);
    });
    
    nextMonthButton.addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar(currentDate);
    });
    
    // Print functionality
    printButton.addEventListener('click', function() {
        window.print();
    });
    
    // Initial render
    renderCalendar(currentDate);
}); // <-- This closes the DOMContentLoaded event listener
</script>
<script src="app.js"></script>

</body>
</html>